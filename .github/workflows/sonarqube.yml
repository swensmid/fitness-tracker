name: Sonar

on:
    push:
        branches:
            - "**"
    pull_request:
        branches:
            - "**"

jobs:
    sonar:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up JDK 17
              uses: actions/setup-java@v2
              with:
                  java-version: "17"
                  distribution: "adopt"

            - name: Install SonarQube Scanner
              run: |
                  curl -sSLo sonar-scanner-cli.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
                  unzip sonar-scanner-cli.zip -d $HOME/sonar-scanner
                  export PATH="$HOME/sonar-scanner/sonar-scanner-4.6.2.2472-linux/bin:$PATH"

            - name: Run SonarQube Scan
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                  JAVA_HOME: /opt/hostedtoolcache/Java_Adopt_jdk/17.0.13-11/x64
              run: |
                  sonar-scanner \
                    -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=${SONAR_HOST_URL} \
                    -Dsonar.login=${SONAR_TOKEN}

            - name: Fail job if quality gate fails
              uses: sonarsource/sonarqube-quality-gate-action@master
              timeout-minutes: 5
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
